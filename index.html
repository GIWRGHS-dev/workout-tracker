<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Workout Tracker</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- UPDATED MANIFEST: Sets orientation to landscape -->
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiV29ya291dCBUcmFja2VyIiwic2hvcnRfbmFtZSI6IldvcmtvdXQiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJvcmllbnRhdGlvbiI6ImxhbmRzY2FwZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDIwNjE3IiwidGhlbWVfY29sb3IiOiIjMGYxNzJhIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzI1NTQvMjU1NDAzNy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==' />

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ============================================================
        // ðŸ”´ YOUR FIREBASE KEYS ðŸ”´
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCp2FLLKB-qhCN5cOoUvHT2nPgo_hXGWh8",
            authDomain: "gym-tracker-b14ce.firebaseapp.com",
            projectId: "gym-tracker-b14ce",
            storageBucket: "gym-tracker-b14ce.firebasestorage.app",
            messagingSenderId: "122178207860",
            appId: "1:122178207860:web:05a1454788223ac39d9121"
        };
        // ============================================================

        if (!firebaseConfig.projectId || firebaseConfig.projectId === "") {
            console.warn("Firebase is not configured. Cloud saving will be disabled.");
            window.firebaseConfigured = false;
        } else {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.firebaseConfigured = true;

            window.saveToFirebase = async (dataPayload) => {
                try {
                    const docRef = await addDoc(collection(db, "workouts"), dataPayload);
                    return { success: true, id: docRef.id };
                } catch (e) {
                    return { success: false, error: e.message };
                }
            };

            window.updateInFirebase = async (docId, dataPayload) => {
                try {
                    const docRef = doc(db, "workouts", docId);
                    await updateDoc(docRef, dataPayload);
                    return { success: true };
                } catch (e) {
                    return { success: false, error: e.message };
                }
            };

            window.getFromFirebase = async (exerciseName) => {
                try {
                    const q = query(collection(db, "workouts"), where("exercise", "==", exerciseName));
                    const querySnapshot = await getDocs(q);
                    const history = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        history.push({
                            id: doc.id,
                            Date: data.date,
                            Exercise: data.exercise,
                            Kg: data.kg,
                            Reps: data.reps,
                            Comment: data.comment
                        });
                    });
                    return history.sort((a, b) => new Date(a.Date) - new Date(b.Date));
                } catch (e) {
                    return [];
                }
            };

            window.getLogsByDateRange = async (startDateStr, endDateStr) => {
                try {
                    const q = query(
                        collection(db, "workouts"), 
                        where("date", ">=", startDateStr),
                        where("date", "<=", endDateStr)
                    );
                    const querySnapshot = await getDocs(q);
                    const logs = [];
                    querySnapshot.forEach((doc) => {
                        const d = doc.data();
                        d.id = doc.id;
                        logs.push(d);
                    });
                    return logs.sort((a, b) => new Date(a.date) - new Date(b.date));
                } catch (e) {
                    return [];
                }
            };
        }
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        emerald: { 400: '#34d399', 500: '#10b981', 600: '#059669' },
                        dark: { 900: '#050508', 800: '#0a0a12' } // Custom ultra-dark
                    },
                    animation: { 
                        'fade-in': 'fade-in 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: { 
                        'fade-in': { 'from': { opacity: '0', transform: 'scale(0.98)' }, 'to': { opacity: '1', transform: 'scale(1)' } },
                        'slide-up': { 'from': { transform: 'translateY(100%)' }, 'to': { transform: 'translateY(0)' } }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'ui-monospace', 'monospace']
                    },
                    boxShadow: {
                        'glow': '0 0 15px -3px rgba(16, 185, 129, 0.3)',
                        'glow-sm': '0 0 8px -2px rgba(16, 185, 129, 0.4)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        body { 
            background-color: #02040a; 
            color: #e2e8f0; 
            -webkit-tap-highlight-color: transparent; 
            /* Subtle Mesh Gradient Background */
            background-image: 
                radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(56, 189, 248, 0.08) 0px, transparent 50%);
            background-attachment: fixed;
        }
        
        /* Modern Glassmorphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-header {
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Neon Glow Utility */
        .text-glow { text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icons = {
            Activity: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Coffee: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Save: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            BarChart2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>,
            Calendar: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            TrendingUp: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            List: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Lightbulb: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
            Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            CloudDownload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>,
            MessageSquare: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Refresh: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>,
            History: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>,
            Alert: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Trash: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Lock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></svg>,
            Unlock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></svg>,
            RotateCcw: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>,
            Dumbbell: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        };

        // --- CONSTANTS ---

        const SPLIT_PPL = {
            "Push": ["Flat Dumbbell Bench Press", "Incline Dumbbell Press", "Dumbbell Overhead Press", "Dumbbell Lateral Raises", "Overhead Tricep Extension", "Double Tricep Kickbacks"],
            "Pull": ["One-Arm Dumbbell Row", "Dumbbell Pullover", "Chest-Supported Row", "Rear Delt Fly", "Dumbbell Bicep Curl", "Hammer Curl"],
            "Legs": ["Goblet Squat", "Bulgarian Split Squat", "Dumbbell RDL (Romanian Deadlift)", "Walking Lunges", "Dumbbell Calf Raise"]
        };

        const SPLIT_SIMPLE = {
            "Monday": ["Flat Dumbbell Bench Press", "Dumbbell Bicep Curl"],
            "Tuesday": ["Dumbbell RDL (Romanian Deadlift)", "Walking Lunges"],
            "Wednesday": ["Dumbbell Overhead Press", "Dumbbell Lateral Raises"],
            "Thursday": [],
            "Friday": ["Goblet Squat", "Dumbbell Calf Raise"],
            "Saturday": [],
            "Sunday": []
        };

        // A map to get tooltips for common exercises
        const EXERCISE_NOTES = {
            "Flat Dumbbell Bench Press": "Lie flat on the bench. Press dumbbells up, bringing them together at the top without touching. Lower slowly.",
            "Incline Dumbbell Press": "Set bench to a 30-45 degree angle. Focus on the upper chest. Keep elbows slightly tucked.",
            "Dumbbell Overhead Press": "Perform standing or seated. Keep core tight and glutes squeezed. Don't arch your lower back excessively.",
            "Dumbbell Lateral Raises": "Stand tall. Raise arms to the side with a slight bend in the elbow. Lead with your elbows, not hands.",
            "Overhead Tricep Extension": "Keep elbows pointing forward/up, not flaring out. Lower the weight behind your head for a deep stretch.",
            "Double Tricep Kickbacks": "Nothing!",
            "One-Arm Dumbbell Row": "Support yourself on a bench. Keep your back flat. Pull the dumbbell towards your hip, not your chest.",
            "Dumbbell Pullover": "Lie perpendicular on a bench or flat on floor. Keep arms slightly bent. Lower weight behind head until you feel a stretch in lats.",
            "Chest-Supported Row": "Lie face down on an incline bench. Row dumbbells up, squeezing shoulder blades together at the top.",
            "Rear Delt Fly": "Hinge at hips so torso is nearly parallel to floor. Fly arms out to side. Focus on the back of the shoulders.",
            "Dumbbell Bicep Curl": "Keep elbows pinned to your sides. Supinate (rotate) palms up as you lift.",
            "Hammer Curl": "Keep palms facing each other throughout the movement. Great for forearm and brachialis.",
            "Goblet Squat": "Hold one heavy DB at chest height. Squat deep, keeping chest up and knees tracking over toes.",
            "Bulgarian Split Squat": "Place one foot on a bench behind you. Lower your hips until back knee almost touches ground. Lean forward slightly for glutes.",
            "Dumbbell RDL (Romanian Deadlift)": "Slight bend in knees. Hinge at hips, pushing butt back. Lower weights until hamstrings are tight. Keep back flat.",
            "Walking Lunges": "Step forward and lower hips. Keep front knee behind toe. Alternate legs. Torso upright.",
            "Dumbbell Calf Raise": "Hold dumbbells at sides. Raise heels as high as possible. Pause at the top."
        };

        // UPDATED: Dynamic sessions based on program type
        const generateSessionLabels = (programType) => {
            if (programType === 'simple') return ['Session 1'];
            return ['Session 1', 'Session 2'];
        };

        // UPDATED: generateInitialData accepts programType
        const generateInitialData = (split, programType = 'ppl') => {
            const data = {};
            const sessionLabels = generateSessionLabels(programType);
            const sourceSplit = split || SPLIT_PPL;
            
            Object.keys(sourceSplit).forEach(dayKey => {
                data[dayKey] = {};
                sourceSplit[dayKey].forEach(ex => {
                    data[dayKey][ex] = {};
                    sessionLabels.forEach(label => {
                        data[dayKey][ex][label] = { 
                            sets: [{ reps: '', weight: '' }, { reps: '', weight: '' }, { reps: '', weight: '' }],
                            completed: false,
                            comment: ""
                        };
                    });
                });
            });
            return data;
        };

        // --- HELPER FUNCTIONS FOR DATES ---
        const getMonday = (d) => {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            return new Date(d.setDate(diff));
        };

        const formatDate = (date) => {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            return `${day}/${month}`;
        };

        const formatDateISO = (date) => {
            return date.toISOString().split('T')[0];
        };

        // --- COMPONENTS ---

        const ProgressChart = ({ historyData }) => {
            if (!historyData || historyData.length === 0) return <div className="text-slate-500 text-center py-8">No history data available yet.</div>;

            const groupedByDate = {};
            historyData.forEach(row => {
                const date = row.Date;
                const weight = parseFloat(row.Kg) || 0;
                const reps = parseInt(row.Reps) || 0;
                if (!groupedByDate[date]) {
                    groupedByDate[date] = { best: { weight, reps }, worst: { weight, reps } };
                } else {
                    const currentBest = groupedByDate[date].best;
                    if (weight > currentBest.weight || (weight === currentBest.weight && reps > currentBest.reps)) groupedByDate[date].best = { weight, reps };
                    const currentWorst = groupedByDate[date].worst;
                    if (weight < currentWorst.weight || (weight === currentWorst.weight && reps < currentWorst.reps)) groupedByDate[date].worst = { weight, reps };
                }
            });

            const chartData = Object.keys(groupedByDate).map(date => ({ date, best: groupedByDate[date].best, worst: groupedByDate[date].worst })).sort((a, b) => new Date(a.date) - new Date(b.date));
            const height = 220;
            const width = 320;
            const padding = 30;
            const maxVal = Math.max(...chartData.map(d => d.best.weight), 10);
            const getX = (index) => (index / (chartData.length - 1 || 1)) * (width - 2 * padding) + padding;
            const getY = (val) => height - padding - (val / maxVal) * (height - 2 * padding);
            const pointsBest = chartData.map((d, i) => `${getX(i)},${getY(d.best.weight)}`).join(' ');
            const pointsWorst = chartData.map((d, i) => `${getX(i)},${getY(d.worst.weight)}`).join(' ');

            return (
                <div className="flex flex-col items-center justify-center p-4 bg-slate-900/50 rounded-2xl border border-white/5 shadow-inner w-full">
                     <div className="w-full flex justify-between text-xs text-slate-500 mb-2 px-2"><span>Start</span><span>Max: {maxVal} kg</span></div>
                     <div className="w-full flex justify-center gap-4 mb-2 text-[10px]">
                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-emerald-500"></span><span className="text-emerald-400">Best Set</span></div>
                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"></span><span className="text-red-400">Worst Set</span></div>
                     </div>
                     <svg width="100%" height={height} viewBox={`0 0 ${width} ${height}`} className="overflow-visible">
                        <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#334155" strokeWidth="2" strokeDasharray="4" />
                        <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#334155" strokeWidth="2" />
                        <polyline points={pointsWorst} fill="none" stroke="#ef4444" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="opacity-50" />
                        <polyline points={pointsBest} fill="none" stroke="#10b981" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="drop-shadow-[0_0_10px_rgba(16,185,129,0.3)]" />
                        {chartData.map((d, i) => { const x = getX(i); const y = getY(d.worst.weight); return (<g key={`worst-${i}`} className="group cursor-pointer"><circle cx={x} cy={y} r="4" fill="#0f172a" stroke="#ef4444" strokeWidth="2" className="transition-all group-hover:r-6 group-hover:fill-red-500/20" /><title>{`WORST SET\nDate: ${d.date}\nWeight: ${d.worst.weight} kg\nReps: ${d.worst.reps}`}</title></g>)})}
                        {chartData.map((d, i) => { const x = getX(i); const y = getY(d.best.weight); return (<g key={`best-${i}`} className="group cursor-pointer"><circle cx={x} cy={y} r="6" fill="#0f172a" stroke="#10b981" strokeWidth="2" className="transition-all group-hover:r-9 group-hover:fill-emerald-500/30" /><title>{`BEST SET\nDate: ${d.date}\nWeight: ${d.best.weight} kg\nReps: ${d.best.reps}`}</title><text x={x} y={y - 15} textAnchor="middle" fill="white" fontSize="10" fontWeight="bold" className="opacity-0 group-hover:opacity-100 transition-opacity select-none bg-black/80 px-2 py-1 rounded pointer-events-none">{d.best.weight}kg</text><text x={x} y={height - 10} textAnchor="middle" fill="#64748b" fontSize="9" className="pointer-events-none font-mono">{d.date.slice(0,5)}</text></g>)})}
                    </svg>
                </div>
            );
        };

        const SettingsModal = ({ initialType, onClose, onSave, onClearData }) => {
            const [localType, setLocalType] = useState(initialType);

            const handleResetDefaults = () => {
                if (confirm("Reset exercise names to default list?")) {
                    const target = localType === 'ppl' ? SPLIT_PPL : SPLIT_SIMPLE;
                    onSave(target, localType);
                }
            };

            const handleClearWeeklyData = () => {
                onClearData();
            };

            const handleSaveInternal = () => {
                let newSplit = null;
                if (localType === 'ppl') newSplit = SPLIT_PPL;
                else newSplit = SPLIT_SIMPLE;

                onSave(newSplit, localType);
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md animate-fade-in">
                    <div className="glass-panel rounded-2xl w-full max-w-sm shadow-2xl flex flex-col border border-white/10">
                        <div className="p-5 border-b border-white/10 bg-white/5 flex justify-between items-center rounded-t-2xl">
                            <h2 className="text-lg font-bold text-white tracking-wide">Program Settings</h2>
                            <button onClick={onClose} className="p-2 text-slate-400 hover:text-white transition-colors hover:bg-white/10 rounded-full"><Icons.X className="w-5 h-5" /></button>
                        </div>
                        
                        <div className="p-6 space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Program Type</label>
                                <div className="bg-slate-950/50 p-1.5 rounded-xl flex text-sm font-medium border border-white/5">
                                    <button 
                                        onClick={() => setLocalType('ppl')}
                                        className={`flex-1 py-2.5 rounded-lg transition-all duration-300 ${localType === 'ppl' ? 'bg-gradient-to-br from-emerald-600 to-teal-600 text-white shadow-lg shadow-emerald-900/50' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}
                                    >
                                        PPL Split
                                    </button>
                                    <button 
                                        onClick={() => setLocalType('simple')}
                                        className={`flex-1 py-2.5 rounded-lg transition-all duration-300 ${localType === 'simple' ? 'bg-gradient-to-br from-emerald-600 to-teal-600 text-white shadow-lg shadow-emerald-900/50' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}
                                    >
                                        Weekly Split
                                    </button>
                                </div>
                                <p className="text-[10px] text-slate-500 mt-3 leading-relaxed">Switching programs will load the default exercises for that split.</p>
                            </div>

                            <div className="pt-4 border-t border-white/10 space-y-3">
                                <button onClick={handleClearWeeklyData} className="w-full py-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 font-bold rounded-xl flex items-center justify-center gap-2 transition-all border border-red-500/20 active:scale-95">
                                    <Icons.Trash className="w-4 h-4" /> Clear Weekly Data
                                </button>
                                <button onClick={handleResetDefaults} className="w-full py-3 bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-all border border-white/5 active:scale-95">
                                    <Icons.Refresh className="w-4 h-4" /> Reset Default List
                                </button>
                            </div>
                        </div>
                        <div className="p-5 border-t border-white/10 bg-white/5 rounded-b-2xl">
                            <button onClick={handleSaveInternal} className="w-full py-3.5 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/20 transition-all active:scale-95 transform"><Icons.Save className="w-4 h-4" /> Save Changes</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [programType, setProgramType] = useState(() => localStorage.getItem('programType_v1') || 'ppl');
            const [workoutSplit, setWorkoutSplit] = useState(() => {
                const saved = localStorage.getItem('workoutSplit_v1');
                return saved ? JSON.parse(saved) : SPLIT_PPL;
            });

            useEffect(() => {
                if (!workoutSplit) {
                    setWorkoutSplit(programType === 'ppl' ? SPLIT_PPL : SPLIT_SIMPLE);
                }
            }, []);

            const [activeDay, setActiveDay] = useState(() => {
                const keys = Object.keys(workoutSplit);
                return keys[0] || "Push";
            });

            const [sessions, setSessions] = useState(() => generateSessionLabels(programType));

            useEffect(() => {
                setSessions(generateSessionLabels(programType));
            }, [programType]);

            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [isEditingExercises, setIsEditingExercises] = useState(false); 
            
            const [selectedHistoryExercise, setSelectedHistoryExercise] = useState(null);
            const [historyData, setHistoryData] = useState([]);
            const [isLoadingHistory, setIsLoadingHistory] = useState(false);
            
            const [workoutData, setWorkoutData] = useState(() => { 
                const saved = localStorage.getItem('workoutData_v9'); 
                if (saved) return JSON.parse(saved);
                return generateInitialData(workoutSplit, programType);
            });
            const [selectedCell, setSelectedCell] = useState(null);
            const [showFirebaseAlert, setShowFirebaseAlert] = useState(false);
            const [isUnlocked, setIsUnlocked] = useState(false);
            const [currentWeekStart, setCurrentWeekStart] = useState(getMonday(new Date()));

            // Persist Data
            useEffect(() => { localStorage.setItem('workoutData_v9', JSON.stringify(workoutData)); }, [workoutData]);
            useEffect(() => { localStorage.setItem('workoutSplit_v1', JSON.stringify(workoutSplit)); }, [workoutSplit]);
            useEffect(() => { localStorage.setItem('programType_v1', programType); }, [programType]);

            useEffect(() => {
                if (window.firebaseConfigured === false) {
                    setShowFirebaseAlert(true);
                }
            }, []);

            // Handle Progress Tab Fetching
            useEffect(() => {
                if (activeDay === 'Progress' && selectedHistoryExercise) {
                    setIsLoadingHistory(true);
                    const fetchFirebase = async () => {
                        if (window.getFromFirebase && window.firebaseConfigured) {
                            const data = await window.getFromFirebase(selectedHistoryExercise);
                            setHistoryData(data);
                        } else {
                            console.error("Firebase Not Initialized");
                            setHistoryData([]);
                        }
                        setIsLoadingHistory(false);
                    };
                    fetchFirebase();
                }
            }, [selectedHistoryExercise, activeDay]);

            const weekRangeString = React.useMemo(() => {
                const end = new Date(currentWeekStart);
                end.setDate(end.getDate() + 6);
                return `${formatDate(currentWeekStart)} - ${formatDate(end)}`;
            }, [currentWeekStart]);

            const changeWeek = (offset) => {
                const newStart = new Date(currentWeekStart);
                newStart.setDate(newStart.getDate() + (offset * 7));
                setCurrentWeekStart(newStart);
                fetchWeeklyData(newStart);
            };

            const fetchWeeklyData = async (startDate) => {
                if (!window.getLogsByDateRange || !window.firebaseConfigured) return;

                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                const startStr = formatDateISO(startDate);
                const endStr = formatDateISO(endDate);

                // Fetch logs
                const logs = await window.getLogsByDateRange(startStr, endStr);
                
                // Re-init data structure based on current split and type
                const newData = generateInitialData(workoutSplit, programType); 

                if (logs && logs.length > 0) {
                    const groupedLogs = {};
                    logs.forEach(log => {
                        const key = `${log.category}|${log.exercise}|${log.session}`;
                        if (!groupedLogs[key]) groupedLogs[key] = [];
                        groupedLogs[key].push(log);
                    });

                    Object.keys(groupedLogs).forEach(key => {
                        const [category, exercise, session] = key.split('|');
                        const sets = groupedLogs[key];
                        
                        if (newData[category] && newData[category][exercise] && newData[category][exercise][session]) {
                            const currentSession = newData[category][exercise][session];
                            const latestSets = sets.slice(-3);
                            
                            latestSets.forEach((setLog, index) => {
                                if (index < 3) {
                                    currentSession.sets[index].reps = setLog.reps;
                                    currentSession.sets[index].weight = setLog.kg;
                                    currentSession.sets[index].docId = setLog.id; 
                                }
                            });
                            if (sets[sets.length - 1].comment) currentSession.comment = sets[sets.length - 1].comment;
                            currentSession.completed = true;
                        }
                    });
                }
                setWorkoutData(newData);
            };

            // UPDATED: handleSaveSplit now accepts newType
            const handleSaveSplit = (newSplit, newType) => {
                setProgramType(newType);
                if (newSplit) { // Only update split if provided (switching types or reset)
                    const newWorkoutData = generateInitialData(newSplit, newType);
                    setWorkoutSplit(newSplit);
                    setWorkoutData(newWorkoutData);
                    
                    // Update active day to first key
                    const keys = Object.keys(newSplit);
                    if (keys.length > 0) setActiveDay(keys[0]);
                }
                
                setShowSettingsModal(false);
            };

            const handleExerciseRename = (day, idx, newName) => {
                const oldName = workoutSplit[day][idx];
                if (oldName === newName) return;

                const newSplit = { ...workoutSplit };
                newSplit[day] = [...newSplit[day]];
                newSplit[day][idx] = newName;
                setWorkoutSplit(newSplit);

                setWorkoutData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    if (newData[day] && newData[day][oldName]) {
                        newData[day][newName] = newData[day][oldName];
                        delete newData[day][oldName];
                    } else {
                        if (!newData[day]) newData[day] = {};
                        newData[day][newName] = {};
                        sessions.forEach(label => {
                            newData[day][newName][label] = { 
                                sets: [{ reps: '', weight: '' }, { reps: '', weight: '' }, { reps: '', weight: '' }],
                                completed: false,
                                comment: ""
                            };
                        });
                    }
                    return newData;
                });
            };

            const handleExerciseAdd = (day) => {
                const newSplit = { ...workoutSplit };
                const newName = "New Exercise " + (newSplit[day].length + 1);
                newSplit[day] = [...newSplit[day], newName];
                setWorkoutSplit(newSplit);
                
                setWorkoutData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    if (!newData[day]) newData[day] = {};
                    newData[day][newName] = {};
                    sessions.forEach(label => {
                        newData[day][newName][label] = { 
                            sets: [{ reps: '', weight: '' }, { reps: '', weight: '' }, { reps: '', weight: '' }],
                            completed: false,
                            comment: ""
                        };
                    });
                    return newData;
                });
            };

            const handleExerciseDelete = (day, idx) => {
                if(!confirm("Remove this exercise?")) return;
                const exerciseName = workoutSplit[day][idx];
                
                const newSplit = { ...workoutSplit };
                newSplit[day] = newSplit[day].filter((_, i) => i !== idx);
                setWorkoutSplit(newSplit);
                
                setWorkoutData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    if (newData[day] && newData[day][exerciseName]) {
                        delete newData[day][exerciseName];
                    }
                    return newData;
                });
            };


            const handleSetUpdate = (dayKey, exercise, session, setIndex, field, value) => {
                setWorkoutData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    
                    if (!newData[dayKey]) newData[dayKey] = {};
                    if (!newData[dayKey][exercise]) { newData[dayKey][exercise] = {}; }
                    
                    const sessionData = newData[dayKey][exercise][session] || { sets: [{ reps: '', weight: '' }, { reps: '', weight: '' }, { reps: '', weight: '' }], completed: false, comment: "" };
                    
                    sessionData.sets[setIndex][field] = value;
                    sessionData.completed = sessionData.sets.some(s => s.reps !== '' || s.weight !== '');
                    
                    newData[dayKey][exercise][session] = sessionData;
                    return newData;
                });
            };

            const handleCommentUpdate = (dayKey, exercise, session, value) => {
                setWorkoutData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    
                    if (!newData[dayKey]) newData[dayKey] = {};
                    if (!newData[dayKey][exercise]) { newData[dayKey][exercise] = {}; }
                    const sessionData = newData[dayKey][exercise][session] || { sets: [{ reps: '', weight: '' }, { reps: '', weight: '' }, { reps: '', weight: '' }], completed: false, comment: "" };
                    
                    sessionData.comment = value;
                    newData[dayKey][exercise][session] = sessionData;
                    return newData;
                });
            };

            const getCompletedSets = (dayKey, exercise, session) => {
                const sets = workoutData[dayKey]?.[exercise]?.[session]?.sets || [];
                return sets.filter(set => set.weight !== '' || set.reps !== '');
            };

            const currentExercises = workoutSplit[activeDay] || [];
            
            const resetAllData = () => { 
                setWorkoutData(generateInitialData(workoutSplit, programType)); 
                setShowResetConfirm(false); 
                setShowSettingsModal(false);
            };

            const handleSaveSession = async (sessionName) => {
                if (!window.firebaseConfigured) {
                    alert("Firebase keys are missing! Data will not be saved to the cloud.");
                    return;
                }

                const sessionDate = new Date(currentWeekStart);
                if (sessionName === "Session 2") {
                    sessionDate.setDate(sessionDate.getDate() + 3); 
                }
                const dateStr = formatDateISO(sessionDate);

                const exercises = workoutSplit[activeDay] || [];
                let processedCount = 0;
                const newWorkoutData = JSON.parse(JSON.stringify(workoutData));

                for (const exercise of exercises) {
                    const sessionData = newWorkoutData[activeDay]?.[exercise]?.[sessionName];
                    if (sessionData && sessionData.sets) {
                        for (let i = 0; i < sessionData.sets.length; i++) {
                            const s = sessionData.sets[i];
                            if (!s.weight || !s.reps) continue;

                            const payload = { 
                                date: dateStr, 
                                exercise: exercise, 
                                reps: parseInt(s.reps), 
                                kg: parseFloat(s.weight), 
                                category: activeDay, 
                                session: sessionName, 
                                comment: sessionData.comment || '' 
                            };

                            if (s.docId) {
                                if (window.updateInFirebase) {
                                    await window.updateInFirebase(s.docId, payload);
                                    processedCount++;
                                }
                            } else {
                                if (window.saveToFirebase) {
                                    const result = await window.saveToFirebase(payload);
                                    if (result.success && result.id) {
                                        s.docId = result.id; 
                                        processedCount++;
                                    }
                                }
                            }
                        }
                    }
                }

                if (processedCount === 0) { 
                    alert("No data found to save!"); 
                } else {
                    // Using a custom alert for aesthetics would be better, but native is fine for now
                    alert(`Successfully saved/updated ${processedCount} sets!`);
                    setWorkoutData(newWorkoutData);
                }
            };

            const renderProgressTab = () => {
                let allExercises = [];
                Object.keys(workoutSplit).forEach(day => {
                    if (day !== 'Rest') allExercises = [...allExercises, ...workoutSplit[day]];
                });
                allExercises = [...new Set(allExercises)].sort(); 

                if (selectedHistoryExercise) {
                    return (
                        <div className="flex-1 p-4 md:p-8 overflow-hidden flex flex-col items-center">
                            <div className="w-full max-w-5xl h-full flex flex-col glass-panel rounded-3xl overflow-hidden relative animate-fade-in shadow-2xl">
                                <div className="flex glass-header sticky top-0 z-10 p-4 items-center gap-4">
                                    <button onClick={() => setSelectedHistoryExercise(null)} className="p-2.5 bg-white/5 hover:bg-white/10 rounded-xl text-slate-300 hover:text-white transition-all backdrop-blur-md border border-white/5"><Icons.ChevronLeft className="w-5 h-5" /></button>
                                    <h2 className="text-xl font-bold text-white line-clamp-1 tracking-tight text-glow">{selectedHistoryExercise}</h2>
                                </div>
                                <div className="flex-1 overflow-y-auto space-y-6 p-6 custom-scrollbar">
                                    <div className="p-6 bg-slate-900/40 rounded-2xl border border-white/5 shadow-inner">
                                        <h3 className="text-xs font-bold text-slate-400 mb-4 flex items-center gap-2 uppercase tracking-widest"><Icons.TrendingUp className="w-4 h-4 text-emerald-400"/> Strength Progression</h3>
                                        {isLoadingHistory ? <div className="text-center py-12 text-slate-500 animate-pulse">Syncing data...</div> : <ProgressChart historyData={historyData} />}
                                    </div>
                                    <div className="p-6 bg-slate-900/40 rounded-2xl border border-white/5">
                                        <h3 className="text-xs font-bold text-slate-400 mb-4 flex items-center gap-2 uppercase tracking-widest"><Icons.List className="w-4 h-4 text-emerald-400"/> History Log</h3>
                                        <div className="space-y-3">
                                            <div className="grid grid-cols-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest px-4 mb-2"><span>Date</span><span className="text-center">Set</span><span className="text-center">Kg</span><span className="text-center">Reps</span></div>
                                            {historyData.length > 0 ? historyData.map((row, idx) => (
                                                <div key={idx} className="grid grid-cols-4 text-sm text-slate-300 p-3 bg-white/5 rounded-xl border border-white/5 hover:bg-white/10 hover:border-emerald-500/30 transition-all cursor-default">
                                                    <span className="text-slate-400 font-mono">{row.Date}</span><span className="text-center text-slate-500 font-bold">{idx + 1}</span><span className="text-center font-bold text-emerald-400">{row.Kg}</span><span className="text-center font-mono text-slate-300">{row.Reps}</span>
                                                </div>
                                            )) : <div className="text-center text-slate-500 py-8 text-sm">No recorded sets yet.</div>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                }
                return (
                     <div className="flex-1 p-4 md:p-8 overflow-hidden flex flex-col items-center">
                         <div className="w-full max-w-5xl h-full flex flex-col glass-panel rounded-3xl overflow-hidden relative animate-fade-in shadow-2xl">
                            <div className="text-center p-8 border-b border-white/5 bg-gradient-to-b from-white/5 to-transparent"><h2 className="text-3xl font-bold text-white mb-2 tracking-tight">Exercise History</h2><p className="text-slate-400 text-sm">Select an exercise to analyze your performance over time.</p></div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto p-6 custom-scrollbar">
                                {allExercises.map(ex => (
                                    <button key={ex} onClick={() => setSelectedHistoryExercise(ex)} className="p-5 bg-white/5 hover:bg-white/10 border border-white/5 hover:border-emerald-500/50 rounded-2xl text-left transition-all hover:shadow-glow-sm hover:scale-[1.01] active:scale-[0.99] group flex items-center justify-between">
                                        <span className="font-bold text-slate-200 group-hover:text-white transition-colors">{ex}</span>
                                        <Icons.ChevronRight className="w-4 h-4 text-slate-600 group-hover:text-emerald-400 transition-colors opacity-0 group-hover:opacity-100" />
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };
            
            const getTabDate = (dayName) => {
                if (programType === 'ppl') return null;
                const days = Object.keys(workoutSplit);
                const idx = days.indexOf(dayName);
                if (idx !== -1) {
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + idx);
                    return formatDate(date);
                }
                return null;
            };

            return (
                <div className="min-h-screen font-sans selection:bg-emerald-500/30 flex flex-col overflow-hidden relative">
                    <nav className="sticky top-0 z-30 glass-header px-6 h-16 flex items-center justify-between shadow-lg flex-none">
                        <div className="flex items-center gap-3"><div className="p-2 bg-gradient-to-br from-emerald-500/20 to-teal-500/20 rounded-xl border border-emerald-500/20 shadow-glow-sm"><Icons.Activity className="w-5 h-5 text-emerald-400" /></div><div><h1 className="font-bold text-lg text-white leading-none tracking-tight">FocusFit</h1><span className="text-[10px] text-slate-400 font-medium tracking-wider uppercase">Pro Tracker</span></div></div>
                         
                         <div className="flex items-center gap-3">
                             <div className="flex items-center bg-slate-900/50 border border-white/10 rounded-xl p-1 backdrop-blur-sm">
                                 <button onClick={() => changeWeek(-1)} className="p-2 text-slate-400 hover:text-white hover:bg-white/10 rounded-lg transition-all active:scale-90"><Icons.ChevronLeft className="w-4 h-4" /></button>
                                 <span className="px-3 text-xs font-mono font-bold text-emerald-400 select-none whitespace-nowrap min-w-[80px] text-center">{weekRangeString}</span>
                                 <button onClick={() => changeWeek(1)} className="p-2 text-slate-400 hover:text-white hover:bg-white/10 rounded-lg transition-all active:scale-90"><Icons.ChevronRight className="w-4 h-4" /></button>
                             </div>
                             <button onClick={() => setShowSettingsModal(true)} className="p-2.5 bg-slate-900/50 hover:bg-slate-800 border border-white/10 rounded-xl text-slate-400 hover:text-white transition-all hover:border-white/20 active:scale-95"><Icons.Settings className="w-5 h-5" /></button>
                         </div>
                    </nav>

                    <div className="sticky top-16 z-20 glass-header border-t-0 border-b border-white/5 overflow-x-auto no-scrollbar flex-none h-14 flex items-center shadow-lg">
                        <div className="flex px-4 min-w-max">
                            {Object.keys(workoutSplit).map((day) => { 
                                const isActive = activeDay === day; 
                                const dateStr = getTabDate(day);
                                return (
                                    <button key={day} onClick={() => { setActiveDay(day); setSelectedHistoryExercise(null); }} className={`relative px-5 py-2 mx-1.5 rounded-full text-xs font-bold transition-all duration-300 whitespace-nowrap flex flex-col items-center justify-center border ${isActive ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/50 shadow-glow-sm' : 'text-slate-400 border-transparent hover:bg-white/5 hover:text-slate-200 hover:border-white/10'}`}>
                                        <div className="flex items-center gap-2">
                                            {day}
                                            {dateStr && <span className={`text-[10px] font-mono opacity-80 ${isActive ? 'text-emerald-200' : 'text-slate-500'}`}>{dateStr}</span>}
                                        </div>
                                    </button>
                                ); 
                            })}
                             <button onClick={() => setActiveDay('Progress')} className={`relative px-5 py-2 mx-1.5 rounded-full text-xs font-bold transition-all duration-300 whitespace-nowrap border ${activeDay === 'Progress' ? 'bg-purple-500/10 text-purple-400 border-purple-500/50 shadow-[0_0_10px_-2px_rgba(168,85,247,0.3)]' : 'text-slate-400 border-transparent hover:bg-white/5 hover:text-slate-200 hover:border-white/10'}`}>Progress</button>
                        </div>
                    </div>

                    <main className="flex-1 overflow-hidden flex flex-col relative">
                        {activeDay === "Progress" ? ( renderProgressTab() ) : (
                            /* TABLE VIEW START */
                            <div className="flex-1 p-4 md:p-8 overflow-hidden flex flex-col items-center">
                                <div className="w-full max-w-5xl h-full flex flex-col glass-panel rounded-3xl overflow-hidden relative animate-fade-in shadow-2xl">
                                    {/* TABLE HEADER */}
                                    <div className="flex glass-header sticky top-0 z-20 backdrop-blur-xl">
                                        <div className="flex-none w-48 md:w-72 p-4 border-r border-white/5 z-20 flex items-center justify-between bg-slate-900/40">
                                            <div className="flex items-center gap-3">
                                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Exercise</span>
                                                <button 
                                                    onClick={() => setIsEditingExercises(!isEditingExercises)} 
                                                    className={`p-1.5 rounded-lg transition-all ${isEditingExercises ? 'text-emerald-400 bg-emerald-500/20 ring-1 ring-emerald-500/50' : 'text-slate-600 hover:text-white hover:bg-white/10'}`}
                                                    title={isEditingExercises ? "Finish Editing" : "Edit Exercises"}
                                                >
                                                    {isEditingExercises ? <Icons.Check className="w-3.5 h-3.5" /> : <Icons.Edit className="w-3.5 h-3.5" />}
                                                </button>
                                            </div>
                                            <span className="text-[9px] font-bold text-slate-600 uppercase tracking-widest hidden md:inline px-2 py-1 bg-white/5 rounded-md border border-white/5">{currentExercises.length} Total</span>
                                        </div>
                                        <div className="flex flex-1 overflow-x-auto no-scrollbar">
                                            {sessions.map((session) => (
                                                <div key={session} className="flex-1 min-w-[120px] py-2 px-1 border-r border-white/5 flex flex-col items-center justify-center text-center bg-slate-900/20">
                                                    <span className={`text-[10px] font-bold uppercase tracking-widest transition-colors ${isEditingExercises ? 'text-slate-700' : 'text-slate-400'}`}>{session.replace('Session ', 'Session ')}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* TABLE BODY */}
                                    <div className="flex-1 overflow-y-auto custom-scrollbar pb-20">
                                        {currentExercises.map((exercise, idx) => (
                                            <div key={idx} className={`flex border-b border-white/5 hover:bg-white/[0.02] transition-colors group ${idx % 2 === 0 ? 'bg-transparent' : 'bg-white/[0.01]'}`}>
                                                <div className="flex-none w-48 md:w-72 py-3 px-4 border-r border-white/5 sticky left-0 z-10 flex flex-col justify-center bg-[#050810]/95 md:bg-transparent md:backdrop-blur-none transition-colors">
                                                    {isEditingExercises ? (
                                                        <div className="flex items-center gap-2 animate-fade-in">
                                                            <input 
                                                                type="text" 
                                                                value={exercise} 
                                                                onChange={(e) => handleExerciseRename(activeDay, idx, e.target.value)}
                                                                className="w-full bg-slate-900/80 border border-white/10 rounded-lg px-3 py-2 text-xs text-white focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500/50 transition-all shadow-inner"
                                                            />
                                                            <button 
                                                                onClick={() => handleExerciseDelete(activeDay, idx)}
                                                                className="text-slate-500 hover:text-red-400 hover:bg-red-500/10 p-2 rounded-lg transition-all"
                                                            >
                                                                <Icons.Trash className="w-3.5 h-3.5" />
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <>
                                                            <span className="text-xs md:text-sm font-semibold text-slate-300 leading-tight md:truncate whitespace-normal group-hover:text-emerald-100 transition-colors">{exercise}</span>
                                                            {EXERCISE_NOTES[exercise] && <span className="text-[9px] text-emerald-500/60 md:hidden mt-1 font-mono flex items-center gap-1"><Icons.Lightbulb className="w-2.5 h-2.5" /> Tip</span>}
                                                        </>
                                                    )}
                                                </div>
                                                <div className={`flex flex-1 ${isEditingExercises ? 'opacity-20 pointer-events-none grayscale blur-[1px]' : ''}`}>
                                                    {sessions.map((session) => {
                                                        const completedSets = getCompletedSets(activeDay, exercise, session);
                                                        const isCompleted = completedSets.length > 0;
                                                        const isSelected = selectedCell?.exercise === exercise && selectedCell?.session === session;
                                                        
                                                        return (
                                                            <div key={`${exercise}-${session}`} className={`flex-1 min-w-[120px] p-1 border-r border-white/5 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 relative group/cell ${isSelected ? 'bg-emerald-500/10 shadow-[inset_0_0_20px_rgba(16,185,129,0.1)]' : 'hover:bg-white/[0.03]'}`} onClick={() => { if(!isEditingExercises) setSelectedCell({ dayKey: activeDay, exercise, session }); }} >
                                                                {isCompleted ? (
                                                                    <div className="flex flex-col gap-1 w-full px-2">
                                                                        {completedSets.map((set, idx) => (
                                                                            <div key={idx} className="flex justify-center items-center gap-1 text-[10px] font-mono text-emerald-300 bg-emerald-500/10 border border-emerald-500/20 rounded-md py-0.5 px-2 shadow-sm">
                                                                                <span className="font-bold">{set.weight}</span>
                                                                                <span className="text-emerald-600 text-[8px]">Ã—</span>
                                                                                <span>{set.reps}</span>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                ) : (
                                                                    <div className="w-full h-full flex items-center justify-center py-4">
                                                                        <div className="h-7 w-16 rounded-full border border-white/5 bg-white/[0.02] flex items-center justify-center text-[9px] font-bold text-slate-600 uppercase tracking-wider group-hover/cell:border-emerald-500/30 group-hover/cell:text-emerald-400 group-hover/cell:bg-emerald-500/5 transition-all shadow-sm">
                                                                           Log
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                        {/* ADD BUTTON IN EDIT MODE */}
                                        {isEditingExercises && (
                                            <div className="p-4 flex justify-center border-t border-dashed border-white/10 bg-white/[0.01]">
                                                <button 
                                                    onClick={() => handleExerciseAdd(activeDay)}
                                                    className="flex items-center gap-2 px-5 py-2.5 bg-slate-800 hover:bg-slate-700 text-emerald-400 text-xs font-bold rounded-xl border border-dashed border-emerald-500/30 hover:border-emerald-500 hover:shadow-glow-sm transition-all"
                                                >
                                                    <Icons.Plus className="w-3.5 h-3.5" /> Add New Exercise
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* FOOTER ACTIONS */}
                                    <div className="absolute bottom-0 left-0 right-0 bg-slate-900/90 border-t border-white/10 flex items-center justify-between p-4 z-30 backdrop-blur-xl">
                                         <div className={`flex gap-3 w-full justify-around ${isEditingExercises ? 'opacity-30 pointer-events-none' : ''}`}>
                                            {sessions.map((session) => (
                                                <button key={session} onClick={() => handleSaveSession(session)} className="flex-1 max-w-[240px] py-3 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white text-[11px] font-bold rounded-xl shadow-lg shadow-emerald-900/30 transition-all flex items-center justify-center gap-2 active:scale-[0.98] border border-white/10">
                                                    <Icons.Save className="w-3.5 h-3.5" /> Save {session}
                                                </button>
                                            ))}
                                         </div>
                                    </div>
                                </div>
                            </div>
                            /* TABLE VIEW END */
                        )}
                    </main>

                    {/* MODALS */}
                    {selectedCell && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:justify-end pointer-events-none">
                            <div className="absolute inset-0 bg-black/70 backdrop-blur-sm pointer-events-auto transition-opacity duration-300" onClick={() => setSelectedCell(null)}></div>
                            <div className="pointer-events-auto w-full sm:w-[400px] h-[80vh] sm:h-screen bg-[#050810]/95 border-l border-white/10 shadow-2xl transform transition-transform duration-300 flex flex-col animate-slide-up sm:animate-slide-left rounded-t-3xl sm:rounded-none backdrop-blur-xl">
                                <div className="p-6 border-b border-white/10 flex justify-between items-start bg-white/5 sticky top-0 rounded-t-3xl sm:rounded-none z-10 backdrop-blur-md">
                                    <div className="flex-1 mr-6">
                                        <h2 className="text-xl font-bold text-white mb-1 line-clamp-1 leading-tight tracking-tight">{selectedCell.exercise}</h2>
                                        <div className="flex items-center gap-2 text-emerald-400 text-xs font-bold uppercase tracking-widest"><Icons.Dumbbell className="w-3.5 h-3.5" /> {selectedCell.session}</div>
                                    </div>
                                    <button onClick={() => setSelectedCell(null)} className="p-2 -mr-2 text-slate-400 hover:text-white hover:bg-white/10 rounded-full transition-all"><Icons.X className="w-6 h-6" /></button>
                                </div>
                                <div className="flex-1 p-6 overflow-y-auto custom-scrollbar">
                                    <div className="space-y-6">
                                        <div className="flex items-center gap-4 px-2">
                                            <div className="w-8 text-center text-[10px] font-bold text-slate-500 uppercase tracking-widest">Set</div>
                                            <div className="flex-1 grid grid-cols-2 gap-4">
                                                <div className="text-center text-[10px] font-bold text-slate-500 uppercase tracking-widest">Weight (KG)</div>
                                                <div className="text-center text-[10px] font-bold text-slate-500 uppercase tracking-widest">Reps</div>
                                            </div>
                                        </div>
                                        
                                        {workoutData[selectedCell.dayKey]?.[selectedCell.exercise]?.[selectedCell.session]?.sets.map((set, index) => (
                                            <div key={index} className="flex items-center gap-4 mb-3 animate-fade-in" style={{animationDelay: `${index * 50}ms`}}>
                                                <div className="flex-none w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-400 border border-white/5 shadow-inner">{index + 1}</div>
                                                <div className="flex-1 grid grid-cols-2 gap-4">
                                                    <div className="relative">
                                                        <input 
                                                            type="number" 
                                                            placeholder="0" 
                                                            value={set.weight} 
                                                            onChange={(e) => handleSetUpdate(selectedCell.dayKey, selectedCell.exercise, selectedCell.session, index, 'weight', e.target.value)} 
                                                            className="w-full bg-white/5 border border-white/10 rounded-xl py-3 text-center font-mono text-lg text-white focus:outline-none focus:border-emerald-500 focus:bg-emerald-500/10 focus:ring-1 focus:ring-emerald-500/50 transition-all placeholder:text-slate-700" 
                                                        />
                                                    </div>
                                                    <div className="relative">
                                                        <input 
                                                            type="number" 
                                                            placeholder="0" 
                                                            value={set.reps} 
                                                            onChange={(e) => handleSetUpdate(selectedCell.dayKey, selectedCell.exercise, selectedCell.session, index, 'reps', e.target.value)} 
                                                            className="w-full bg-white/5 border border-white/10 rounded-xl py-3 text-center font-mono text-lg text-white focus:outline-none focus:border-emerald-500 focus:bg-emerald-500/10 focus:ring-1 focus:ring-emerald-500/50 transition-all placeholder:text-slate-700" 
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                        ))}

                                        <div className="mt-8 space-y-4">
                                            {EXERCISE_NOTES[selectedCell.exercise] && (
                                                <div className="p-4 rounded-xl bg-blue-500/10 border border-blue-500/20 shadow-[0_0_15px_-5px_rgba(59,130,246,0.2)]">
                                                    <h4 className="flex items-center gap-2 text-xs font-bold text-blue-300 mb-1.5 uppercase tracking-wider"><Icons.Lightbulb className="w-3.5 h-3.5" /> Form Cue</h4>
                                                    <p className="text-xs text-slate-300 leading-relaxed font-medium">{EXERCISE_NOTES[selectedCell.exercise]}</p>
                                                </div>
                                            )}
                                            
                                            <div>
                                                <h4 className="flex items-center gap-2 text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider"><Icons.MessageSquare className="w-3.5 h-3.5" /> Session Notes</h4>
                                                <textarea 
                                                    value={workoutData[selectedCell.dayKey]?.[selectedCell.exercise]?.[selectedCell.session]?.comment || ''} 
                                                    onChange={(e) => handleCommentUpdate(selectedCell.dayKey, selectedCell.exercise, selectedCell.session, e.target.value)} 
                                                    className="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-sm text-slate-300 focus:outline-none focus:border-emerald-500/50 focus:bg-white/10 transition-all resize-none h-24 placeholder:text-slate-600 shadow-inner"
                                                    placeholder="How did it feel? Any pain? Next time increase weight?..."
                                                ></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-6 border-t border-white/10 bg-slate-900/80 pb-8 sm:pb-6 backdrop-blur-xl">
                                    <button onClick={() => setSelectedCell(null)} className="w-full py-4 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-900/30 transition-all active:scale-[0.98] flex items-center justify-center gap-2 border border-white/10 text-sm tracking-wide">
                                        <Icons.Check className="w-5 h-5" /> Save & Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showResetConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-fade-in">
                            <div className="glass-panel border-white/10 rounded-2xl p-6 max-w-sm w-full shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-2">Reset Weekly Data?</h3>
                                <p className="text-slate-400 text-sm mb-6 leading-relaxed">This will clear all sets logged for the current week. History graphs will remain, but this week's table will be empty.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowResetConfirm(false)} className="flex-1 py-3 bg-white/5 hover:bg-white/10 text-white font-bold rounded-xl text-sm transition-colors border border-white/5">Cancel</button>
                                    <button onClick={resetAllData} className="flex-1 py-3 bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30 font-bold rounded-xl text-sm transition-colors">Reset Data</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSettingsModal && <SettingsModal initialType={programType} onClose={() => setShowSettingsModal(false)} onSave={handleSaveSplit} onClearData={() => setShowResetConfirm(true)} />}
                    
                    {showFirebaseAlert && (
                        <div className="fixed top-0 left-0 right-0 p-3 bg-red-500/90 text-white text-center font-bold z-[60] backdrop-blur-md shadow-lg">
                            <div className="flex items-center justify-center gap-2 text-xs">
                                <Icons.Alert className="w-4 h-4" />
                                <span>Cloud Sync Disabled (Missing API Keys)</span>
                                <button onClick={() => setShowFirebaseAlert(false)} className="ml-4 hover:bg-white/20 rounded p-1"><Icons.X className="w-3 h-3" /></button>
                            </div>
                        </div>
                    )}
                    
                    {/* PORTRAIT ROTATION PROMPT */}
                    <div className="fixed inset-0 z-[9999] bg-[#02040a] flex flex-col items-center justify-center p-8 text-center md:hidden portrait:flex landscape:hidden">
                       <div className="relative mb-6">
                           <div className="absolute inset-0 bg-emerald-500/20 blur-xl rounded-full"></div>
                           <Icons.RotateCcw className="relative w-16 h-16 text-emerald-400 animate-spin-slow" />
                       </div>
                       <h2 className="text-2xl font-bold text-white mb-3">Rotate Your Phone</h2>
                       <p className="text-slate-400 text-sm max-w-xs leading-relaxed">FocusFit is designed for landscape mode to give you the best overview of your weekly progress.</p>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
