<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Workout Tracker</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- UPDATED MANIFEST: Sets orientation to landscape -->
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiV29ya291dCBUcmFja2VyIiwic2hvcnRfbmFtZSI6IldvcmtvdXQiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJvcmllbnRhdGlvbiI6ImxhbmRzY2FwZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDIwNjE3IiwidGhlbWVfY29sb3IiOiIjMGYxNzJhIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzI1NTQvMjU1NDAzNy5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==' />

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ============================================================
        // ðŸ”´ YOUR FIREBASE KEYS ðŸ”´
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCp2FLLKB-qhCN5cOoUvHT2nPgo_hXGWh8",
            authDomain: "gym-tracker-b14ce.firebaseapp.com",
            projectId: "gym-tracker-b14ce",
            storageBucket: "gym-tracker-b14ce.firebasestorage.app",
            messagingSenderId: "122178207860",
            appId: "1:122178207860:web:05a1454788223ac39d9121"
        };
        // ============================================================

        if (!firebaseConfig.projectId || firebaseConfig.projectId === "") {
            console.warn("Firebase is not configured. Cloud saving will be disabled.");
            window.firebaseConfigured = false;
        } else {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.firebaseConfigured = true;

            window.saveToFirebase = async (dataPayload) => {
                try {
                    const docRef = await addDoc(collection(db, "workouts"), dataPayload);
                    return { success: true, id: docRef.id };
                } catch (e) {
                    return { success: false, error: e.message };
                }
            };

            window.updateInFirebase = async (docId, dataPayload) => {
                try {
                    const docRef = doc(db, "workouts", docId);
                    await updateDoc(docRef, dataPayload);
                    return { success: true };
                } catch (e) {
                    return { success: false, error: e.message };
                }
            };

            window.getFromFirebase = async (exerciseName) => {
                try {
                    const q = query(collection(db, "workouts"), where("exercise", "==", exerciseName));
                    const querySnapshot = await getDocs(q);
                    const history = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        history.push({
                            id: doc.id,
                            Date: data.date,
                            Exercise: data.exercise,
                            Kg: data.kg,
                            Reps: data.reps,
                            Comment: data.comment
                        });
                    });
                    return history.sort((a, b) => new Date(a.Date) - new Date(b.Date));
                } catch (e) {
                    return [];
                }
            };

            window.getLogsByDateRange = async (startDateStr, endDateStr) => {
                try {
                    const q = query(
                        collection(db, "workouts"), 
                        where("date", ">=", startDateStr),
                        where("date", "<=", endDateStr)
                    );
                    const querySnapshot = await getDocs(q);
                    const logs = [];
                    querySnapshot.forEach((doc) => {
                        const d = doc.data();
                        d.id = doc.id;
                        logs.push(d);
                    });
                    return logs.sort((a, b) => new Date(a.date) - new Date(b.date));
                } catch (e) {
                    return [];
                }
            };
        }
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        emerald: { 400: '#34d399', 500: '#10b981', 600: '#059669' }
                    },
                    animation: { 
                        'fade-in': 'fade-in 0.3s ease-out forwards',
                        'slide-up': 'slide-up 0.3s ease-out forwards',
                        'slide-left': 'slide-left 0.3s ease-out forwards'
                    },
                    keyframes: { 
                        'fade-in': { 'from': { opacity: '0', transform: 'scale(0.99)' }, 'to': { opacity: '1', transform: 'scale(1)' } },
                        'slide-up': { 'from': { transform: 'translateY(100%)' }, 'to': { transform: 'translateY(0)' } },
                        'slide-left': { 'from': { transform: 'translateX(100%)' }, 'to': { transform: 'translateX(0)' } }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'ui-monospace', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        
        body { background-color: #020617; color: #e2e8f0; -webkit-tap-highlight-color: transparent; }
        
        /* Glassmorphism utility */
        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icons = {
            Activity: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Coffee: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Save: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            BarChart2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>,
            Calendar: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            TrendingUp: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            List: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Lightbulb: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
            Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            CloudDownload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>,
            MessageSquare: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Refresh: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>,
            History: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>,
            Alert: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Trash: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Lock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></svg>,
            Unlock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></svg>,
            RotateCcw: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>,
            Dumbbell: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        };

        // --- CONSTANTS ---

        const SPLIT_PPL = {
            "Push": ["Flat Dumbbell Bench Press", "Incline Dumbbell Press", "Dumbbell Overhead Press", "Dumbbell Lateral Raises", "Overhead Tricep Extension", "Double Tricep Kickbacks"],
            "Pull": ["One-Arm Dumbbell Row", "Dumbbell Pullover", "Chest-Supported Row", "Rear Delt Fly", "Dumbbell Bicep Curl", "Hammer Curl"],
            "Legs": ["Goblet Squat", "Bulgarian Split Squat", "Dumbbell RDL (Romanian Deadlift)", "Walking Lunges", "Dumbbell Calf Raise"],
            "Rest": [] 
        };

        const SPLIT_SIMPLE = {
            "Monday": ["Flat Dumbbell Bench Press", "Dumbbell Bicep Curl"],
            "Tuesday": ["Dumbbell RDL (Romanian Deadlift)", "Walking Lunges"],
            "Wednesday": ["Dumbbell Overhead Press", "Dumbbell Lateral Raises"],
            "Thursday": [],
            "Friday": ["Goblet Squat", "Dumbbell Calf Raise"],
            "Saturday": [],
            "Sunday": [],
            "Rest": []
        };

        // A map to get tooltips for common exercises
        const EXERCISE_NOTES = {
            "Flat Dumbbell Bench Press": "Lie flat on the bench. Press dumbbells up, bringing them together at the top without touching. Lower slowly.",
            "Incline Dumbbell Press": "Set bench to a 30-45 degree angle. Focus on the upper chest. Keep elbows slightly tucked.",
            "Dumbbell Overhead Press": "Perform standing or seated. Keep core tight and glutes squeezed. Don't arch your lower back excessively.",
            "Dumbbell Lateral Raises": "Stand tall. Raise arms to the side with a slight bend in the elbow. Lead with your elbows, not hands.",
            "Overhead Tricep Extension": "Keep elbows pointing forward/up, not flaring out. Lower the weight behind your head for a deep stretch.",
            "Double Tricep Kickbacks": "Nothing!",
            "One-Arm Dumbbell Row": "Support yourself on a bench. Keep your back flat. Pull the dumbbell towards your hip, not your chest.",
            "Dumbbell Pullover": "Lie perpendicular on a bench or flat on floor. Keep arms slightly bent. Lower weight behind head until you feel a stretch in lats.",
            "Chest-Supported Row": "Lie face down on an incline bench. Row dumbbells up, squeezing shoulder blades together at the top.",
            "Rear Delt Fly": "Hinge at hips so torso is nearly parallel to floor. Fly arms out to side. Focus on the back of the shoulders.",
            "Dumbbell Bicep Curl": "Keep elbows pinned to your sides. Supinate (rotate) palms up as you lift.",
            "Hammer Curl": "Keep palms facing each other throughout the movement. Great for forearm and brachialis.",
            "Goblet Squat": "Hold one heavy DB at chest height. Squat deep, keeping chest up and knees tracking over toes.",
            "Bulgarian Split Squat": "Place one foot on a bench behind you. Lower your hips until back knee almost touches ground. Lean forward slightly for glutes.",
            "Dumbbell RDL (Romanian Deadlift)": "Slight bend in knees. Hinge at hips, pushing butt back. Lower weights until hamstrings are tight. Keep back flat.",
            "Walking Lunges": "Step forward and lower hips. Keep front knee behind toe. Alternate legs. Torso upright.",
            "Dumbbell Calf Raise": "Hold dumbbells at sides. Raise heels as high as possible. Pause at the top."
        };

        // UPDATED: Dynamic sessions based on program type
        const generateSessionLabels = (programType) => {
            if (programType === 'simple') return ['Session 1'];
            return ['Session 1', 'Session 2'];
        };

        // UPDATED: generateInitialData accepts programType
        const generateInitialData = (split, programType = 'ppl') => {
            const data = {};
            const sessionLabels = generateSessionLabels(programType);
            const sourceSplit = split || SPLIT_PPL;
            
            Object.keys(sourceSplit).forEach(dayKey => {
                if (dayKey === "Rest") return;
                data[dayKey] = {};
                sourceSplit[dayKey].forEach(ex => {
                    data[dayKey][ex] = {};
                    sessionLabels.forEach(label => {
                        data[dayKey][ex][label] = { 
                            sets: [{ reps: '', weight: '' }, { reps: '', weight: '' }, { reps: '', weight: '' }],
                            completed: false,
                            comment: ""
                        };
                    });
                });
            });
            return data;
        };

        // --- HELPER FUNCTIONS FOR DATES ---
        const getMonday = (d) => {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            return new Date(d.setDate(diff));
        };

        const formatDate = (date) => {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            return `${day}/${month}`;
        };

        const formatDateISO = (date) => {
            return date.toISOString().split('T')[0];
        };

        // --- COMPONENTS ---

        const ProgressChart = ({ historyData }) => {
            if (!historyData || historyData.length === 0) return <div className="text-slate-500 text-center py-8">No history data available yet.</div>;

            const groupedByDate = {};
            historyData.forEach(row => {
                const date = row.Date;
                const weight = parseFloat(row.Kg) || 0;
                const reps = parseInt(row.Reps) || 0;
                if (!groupedByDate[date]) {
                    groupedByDate[date] = { best: { weight, reps }, worst: { weight, reps } };
                } else {
                    const currentBest = groupedByDate[date].best;
                    if (weight > currentBest.weight || (weight === currentBest.weight && reps > currentBest.reps)) groupedByDate[date].best = { weight, reps };
                    const currentWorst = groupedByDate[date].worst;
                    if (weight < currentWorst.weight || (weight === currentWorst.weight && reps < currentWorst.reps)) groupedByDate[date].worst = { weight, reps };
                }
            });

            const chartData = Object.keys(groupedByDate).map(date => ({ date, best: groupedByDate[date].best, worst: groupedByDate[date].worst })).sort((a, b) => new Date(a.date) - new Date(b.date));
            const height = 220;
            const width = 320;
            const padding = 30;
            const maxVal = Math.max(...chartData.map(d => d.best.weight), 10);
            const getX = (index) => (index / (chartData.length - 1 || 1)) * (width - 2 * padding) + padding;
            const getY = (val) => height - padding - (val / maxVal) * (height - 2 * padding);
            const pointsBest = chartData.map((d, i) => `${getX(i)},${getY(d.best.weight)}`).join(' ');
            const pointsWorst = chartData.map((d, i) => `${getX(i)},${getY(d.worst.weight)}`).join(' ');

            return (
                <div className="flex flex-col items-center justify-center p-4 bg-slate-900 rounded-xl border border-slate-800 shadow-inner w-full">
                     <div className="w-full flex justify-between text-xs text-slate-500 mb-2 px-2"><span>Start</span><span>Max: {maxVal} kg</span></div>
                     <div className="w-full flex justify-center gap-4 mb-2 text-[10px]">
                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-emerald-500"></span><span className="text-emerald-400">Best Set</span></div>
                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"></span><span className="text-red-400">Worst Set</span></div>
                     </div>
                     <svg width="100%" height={height} viewBox={`0 0 ${width} ${height}`} className="overflow-visible">
                        <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#334155" strokeWidth="2" />
                        <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#334155" strokeWidth="2" />
                        <polyline points={pointsWorst} fill="none" stroke="#ef4444" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="opacity-50" />
                        <polyline points={pointsBest} fill="none" stroke="#10b981" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="drop-shadow-[0_0_10px_rgba(16,185,129,0.3)]" />
                        {chartData.map((d, i) => { const x = getX(i); const y = getY(d.worst.weight); return (<g key={`worst-${i}`} className="group cursor-pointer"><circle cx={x} cy={y} r="4" fill="#0f172a" stroke="#ef4444" strokeWidth="2" className="transition-all group-hover:r-6 group-hover:fill-red-500/20" /><title>{`WORST SET\nDate: ${d.date}\nWeight: ${d.worst.weight} kg\nReps: ${d.worst.reps}`}</title></g>)})}
                        {chartData.map((d, i) => { const x = getX(i); const y = getY(d.best.weight); return (<g key={`best-${i}`} className="group cursor-pointer"><circle cx={x} cy={y} r="5" fill="#0f172a" stroke="#10b981" strokeWidth="2" className="transition-all group-hover:r-7 group-hover:fill-emerald-500/20" /><title>{`BEST SET\nDate: ${d.date}\nWeight: ${d.best.weight} kg\nReps: ${d.best.reps}`}</title><text x={x} y={y - 12} textAnchor="middle" fill="white" fontSize="10" fontWeight="bold" className="opacity-0 group-hover:opacity-100 transition-opacity select-none bg-black pointer-events-none">{d.best.weight}kg</text><text x={x} y={height - 10} textAnchor="middle" fill="#64748b" fontSize="8" className="pointer-events-none">{d.date.slice(5)}</text></g>)})}
                    </svg>
                </div>
            );
        };

        const EditExercisesModal = ({ currentSplit, initialType, onClose, onSave }) => {
            // UPDATED: Manage local type state to avoid background flickering
            const [localType, setLocalType] = useState(initialType);

            const [localSplitArr, setLocalSplitArr] = useState(() => {
                return Object.keys(currentSplit).map(key => ({
                    key: key,
                    exercises: currentSplit[key]
                }));
            });

            // Update local split array when type changes internally in modal
            useEffect(() => {
                if (localType === 'ppl') {
                    setLocalSplitArr(Object.keys(SPLIT_PPL).map(key => ({ key, exercises: SPLIT_PPL[key] })));
                } else if (localType === 'simple') {
                    setLocalSplitArr(Object.keys(SPLIT_SIMPLE).map(key => ({ key, exercises: SPLIT_SIMPLE[key] })));
                }
            }, [localType]);

            const handleNameChange = (dayIndex, exIndex, newName) => {
                const updated = [...localSplitArr];
                updated[dayIndex].exercises[exIndex] = newName;
                setLocalSplitArr(updated);
            };

            const handleTitleChange = (dayIndex, newTitle) => {
                const updated = [...localSplitArr];
                updated[dayIndex].key = newTitle;
                setLocalSplitArr(updated);
            };

            const handleDeleteExercise = (dayIndex, exIndex) => {
                const updated = [...localSplitArr];
                updated[dayIndex].exercises = updated[dayIndex].exercises.filter((_, i) => i !== exIndex);
                setLocalSplitArr(updated);
            };

            const handleAddExercise = (dayIndex) => {
                const updated = [...localSplitArr];
                updated[dayIndex].exercises.push("New Exercise");
                setLocalSplitArr(updated);
            };

            const handleReset = () => {
                if (confirm("Reset current program to defaults?")) {
                    const target = localType === 'ppl' ? SPLIT_PPL : SPLIT_SIMPLE;
                    setLocalSplitArr(Object.keys(target).map(key => ({ key, exercises: target[key] })));
                }
            };

            const handleSaveInternal = () => {
                const finalObj = {};
                localSplitArr.forEach(item => {
                    finalObj[item.key] = item.exercises;
                });
                onSave(finalObj, localType); // Pass back the final type
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                    <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg shadow-2xl flex flex-col max-h-[85vh]">
                        <div className="p-4 border-b border-slate-700 bg-slate-900 sticky top-0 rounded-t-2xl z-10 space-y-4">
                            <div className="flex justify-between items-center">
                                <h2 className="text-lg font-bold text-white">Settings</h2>
                                <button onClick={onClose} className="p-2 text-slate-400 hover:text-white"><Icons.X className="w-6 h-6" /></button>
                            </div>
                            
                            <div className="bg-slate-800 p-1 rounded-lg flex text-sm font-medium">
                                <button 
                                    onClick={() => setLocalType('ppl')}
                                    className={`flex-1 py-2 rounded-md transition-colors ${localType === 'ppl' ? 'bg-emerald-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                >
                                    Push / Pull / Legs
                                </button>
                                <button 
                                    onClick={() => setLocalType('simple')}
                                    className={`flex-1 py-2 rounded-md transition-colors ${localType === 'simple' ? 'bg-emerald-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                >
                                    Weekly (Mon-Sun)
                                </button>
                            </div>
                        </div>

                        <div className="overflow-y-auto p-4 space-y-6 custom-scrollbar">
                            {localSplitArr.map((dayObj, dayIdx) => {
                                if (dayObj.key === "Rest") return null;
                                return (
                                    <div key={dayIdx}>
                                        <div className="flex items-center gap-2 mb-3">
                                            {localType === 'simple' ? (
                                                <input 
                                                    type="text" 
                                                    value={dayObj.key}
                                                    onChange={(e) => handleTitleChange(dayIdx, e.target.value)}
                                                    className="bg-transparent text-emerald-400 font-bold text-sm uppercase tracking-wider border-b border-dashed border-emerald-500/50 focus:border-emerald-500 focus:outline-none w-full"
                                                />
                                            ) : (
                                                <h3 className="text-emerald-400 font-bold text-sm uppercase tracking-wider">{dayObj.key}</h3>
                                            )}
                                        </div>
                                        
                                        <div className="space-y-3 pl-2 border-l border-slate-800">
                                            {dayObj.exercises.map((ex, exIdx) => (
                                                <div key={exIdx} className="flex gap-2 items-center group">
                                                    <span className="text-slate-500 font-mono text-xs w-4">{exIdx + 1}.</span>
                                                    <input 
                                                        type="text" 
                                                        value={ex} 
                                                        onChange={(e) => handleNameChange(dayIdx, exIdx, e.target.value)}
                                                        className="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 focus:outline-none"
                                                    />
                                                    <button 
                                                        onClick={() => handleDeleteExercise(dayIdx, exIdx)}
                                                        className="p-2 text-slate-600 hover:text-red-400 transition-colors"
                                                        title="Delete Exercise"
                                                    >
                                                        <Icons.Trash className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            ))}
                                            <button 
                                                onClick={() => handleAddExercise(dayIdx)}
                                                className="mt-2 text-xs flex items-center gap-1 text-emerald-500 hover:text-emerald-400 font-medium py-1 px-2 rounded hover:bg-emerald-500/10 transition-colors"
                                            >
                                                <Icons.Plus className="w-3 h-3" /> Add Exercise
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                            <div className="pt-4 border-t border-slate-800">
                                <button onClick={handleReset} className="text-xs text-red-400 hover:text-red-300 underline">Reset to Default Exercises</button>
                            </div>
                        </div>
                        <div className="p-4 border-t border-slate-700 bg-slate-900 rounded-b-2xl">
                            <button onClick={handleSaveInternal} className="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl flex items-center justify-center gap-2"><Icons.Save className="w-4 h-4" /> Save Changes</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            // STATE: Program Type ('ppl' or 'simple')
            const [programType, setProgramType] = useState(() => localStorage.getItem('programType_v1') || 'ppl');

            // STATE: Workout Split (Customizable)
            const [workoutSplit, setWorkoutSplit] = useState(() => {
                const saved = localStorage.getItem('workoutSplit_v1');
                return saved ? JSON.parse(saved) : SPLIT_PPL;
            });

            // Effect to manage initial split on first load or type switch fallback
            useEffect(() => {
                if (!workoutSplit) {
                    setWorkoutSplit(programType === 'ppl' ? SPLIT_PPL : SPLIT_SIMPLE);
                }
            }, []);

            // Set active day based on split keys
            const [activeDay, setActiveDay] = useState(() => {
                const keys = Object.keys(workoutSplit).filter(k => k !== 'Rest');
                return keys[0] || "Push";
            });

            // UPDATED: Sessions state derived from programType
            const [sessions, setSessions] = useState(() => generateSessionLabels(programType));

            // UPDATED: Effect to update sessions when programType changes
            useEffect(() => {
                setSessions(generateSessionLabels(programType));
            }, [programType]);

            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showEditModal, setShowEditModal] = useState(false);
            
            const [selectedHistoryExercise, setSelectedHistoryExercise] = useState(null);
            const [historyData, setHistoryData] = useState([]);
            const [isLoadingHistory, setIsLoadingHistory] = useState(false);
            
            // NOTE: Initializing workoutData based on current workoutSplit
            const [workoutData, setWorkoutData] = useState(() => { 
                const saved = localStorage.getItem('workoutData_v9'); 
                if (saved) return JSON.parse(saved);
                return generateInitialData(workoutSplit, programType);
            });
            const [selectedCell, setSelectedCell] = useState(null);
            const [showFirebaseAlert, setShowFirebaseAlert] = useState(false);
            
            // NEW STATE: UNLOCK EDIT
            const [isUnlocked, setIsUnlocked] = useState(false);

            const [currentWeekStart, setCurrentWeekStart] = useState(getMonday(new Date()));

            // Persist Data
            useEffect(() => { localStorage.setItem('workoutData_v9', JSON.stringify(workoutData)); }, [workoutData]);
            useEffect(() => { localStorage.setItem('workoutSplit_v1', JSON.stringify(workoutSplit)); }, [workoutSplit]);
            useEffect(() => { localStorage.setItem('programType_v1', programType); }, [programType]);

            useEffect(() => {
                if (window.firebaseConfigured === false) {
                    setShowFirebaseAlert(true);
                }
            }, []);

            // Handle Progress Tab Fetching
            useEffect(() => {
                if (activeDay === 'Progress' && selectedHistoryExercise) {
                    setIsLoadingHistory(true);
                    const fetchFirebase = async () => {
                        if (window.getFromFirebase && window.firebaseConfigured) {
                            const data = await window.getFromFirebase(selectedHistoryExercise);
                            setHistoryData(data);
                        } else {
                            console.error("Firebase Not Initialized");
                            setHistoryData([]);
                        }
                        setIsLoadingHistory(false);
                    };
                    fetchFirebase();
                }
            }, [selectedHistoryExercise, activeDay]);

            const weekRangeString = React.useMemo(() => {
                const end = new Date(currentWeekStart);
                end.setDate(end.getDate() + 6);
                return `${formatDate(currentWeekStart)} - ${formatDate(end)}`;
            }, [currentWeekStart]);

            const changeWeek = (offset) => {
                const newStart = new Date(currentWeekStart);
                newStart.setDate(newStart.getDate() + (offset * 7));
                setCurrentWeekStart(newStart);
                fetchWeeklyData(newStart);
            };

            const fetchWeeklyData = async (startDate) => {
                if (!window.getLogsByDateRange || !window.firebaseConfigured) return;

                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                const startStr = formatDateISO(startDate);
                const endStr = formatDateISO(endDate);

                // Fetch logs
                const logs = await window.getLogsByDateRange(startStr, endStr);
                
                // Re-init data structure based on current split and type
                const newData = generateInitialData(workoutSplit, programType); 

                if (logs && logs.length > 0) {
                    const groupedLogs = {};
                    logs.forEach(log => {
                        const key = `${log.category}|${log.exercise}|${log.session}`;
                        if (!groupedLogs[key]) groupedLogs[key] = [];
                        groupedLogs[key].push(log);
                    });

                    Object.keys(groupedLogs).forEach(key => {
                        const [category, exercise, session] = key.split('|');
                        const sets = groupedLogs[key];
                        
                        if (newData[category] && newData[category][exercise] && newData[category][exercise][session]) {
                            const currentSession = newData[category][exercise][session];
                            const latestSets = sets.slice(-3);
                            
                            latestSets.forEach((setLog, index) => {
                                if (index < 3) {
                                    currentSession.sets[index].reps = setLog.reps;
                                    currentSession.sets[index].weight = setLog.kg;
                                    currentSession.sets[index].docId = setLog.id; 
                                }
                            });
                            if (sets[sets.length - 1].comment) currentSession.comment = sets[sets.length - 1].comment;
                            currentSession.completed = true;
                        }
                    });
                }
                setWorkoutData(newData);
            };

            // UPDATED: handleSaveSplit now accepts newType
            const handleSaveSplit = (newSplit, newType) => {
                setProgramType(newType);
                const newWorkoutData = generateInitialData(newSplit, newType);
                setWorkoutSplit(newSplit);
                setWorkoutData(newWorkoutData);
                
                // Update active day to first key
                const keys = Object.keys(newSplit).filter(k => k !== 'Rest');
                if (keys.length > 0) setActiveDay(keys[0]);
                
                setShowEditModal(false);
            };

            const handleSetUpdate = (dayKey, exercise, session, setIndex, field, value) => {
                setWorkoutData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    
                    if (!newData[dayKey]) newData[dayKey] = {};
                    if (!newData[dayKey][exercise]) { newData[dayKey][exercise] = {}; }
                    
                    const sessionData = newData[dayKey][exercise][session] || { sets: [{ reps: '', weight: '' }, { reps: '', weight: '' }, { reps: '', weight: '' }], completed: false, comment: "" };
                    
                    sessionData.sets[setIndex][field] = value;
                    
                    // Update completion status
                    sessionData.completed = sessionData.sets.some(s => s.reps !== '' || s.weight !== '');
                    
                    newData[dayKey][exercise][session] = sessionData;
                    return newData;
                });
            };

            const handleCommentUpdate = (dayKey, exercise, session, value) => {
                setWorkoutData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    
                    if (!newData[dayKey]) newData[dayKey] = {};
                    if (!newData[dayKey][exercise]) { newData[dayKey][exercise] = {}; }
                    const sessionData = newData[dayKey][exercise][session] || { sets: [{ reps: '', weight: '' }, { reps: '', weight: '' }, { reps: '', weight: '' }], completed: false, comment: "" };
                    
                    sessionData.comment = value;
                    newData[dayKey][exercise][session] = sessionData;
                    return newData;
                });
            };

            const getCompletedSets = (dayKey, exercise, session) => {
                const sets = workoutData[dayKey]?.[exercise]?.[session]?.sets || [];
                return sets.filter(set => set.weight !== '' || set.reps !== '');
            };

            // Dynamic current exercises based on split
            const currentExercises = workoutSplit[activeDay] || [];
            
            // UPDATED: Pass programType to generateInitialData
            const resetAllData = () => { setWorkoutData(generateInitialData(workoutSplit, programType)); setShowResetConfirm(false); };

            const handleSaveSession = async (sessionName) => {
                if (!window.firebaseConfigured) {
                    alert("Firebase keys are missing! Data will not be saved to the cloud.");
                    return;
                }

                const sessionDate = new Date(currentWeekStart);
                if (sessionName === "Session 2") {
                    sessionDate.setDate(sessionDate.getDate() + 3); 
                }
                const dateStr = formatDateISO(sessionDate);

                const exercises = workoutSplit[activeDay] || [];
                let processedCount = 0;
                
                // CREATE DEEP COPY FOR ID UPDATES
                const newWorkoutData = JSON.parse(JSON.stringify(workoutData));

                for (const exercise of exercises) {
                    const sessionData = newWorkoutData[activeDay]?.[exercise]?.[sessionName];
                    if (sessionData && sessionData.sets) {
                        const validSets = sessionData.sets.filter(s => s.weight && s.reps);
                        
                        for (let i = 0; i < sessionData.sets.length; i++) {
                            const s = sessionData.sets[i];
                            if (!s.weight || !s.reps) continue;

                            const payload = { 
                                date: dateStr, 
                                exercise: exercise, 
                                reps: parseInt(s.reps), 
                                kg: parseFloat(s.weight), 
                                category: activeDay, 
                                session: sessionName, 
                                comment: sessionData.comment || '' 
                            };

                            if (s.docId) {
                                if (window.updateInFirebase) {
                                    await window.updateInFirebase(s.docId, payload);
                                    processedCount++;
                                }
                            } else {
                                if (window.saveToFirebase) {
                                    const result = await window.saveToFirebase(payload);
                                    if (result.success && result.id) {
                                        s.docId = result.id; 
                                        processedCount++;
                                    }
                                }
                            }
                        }
                    }
                }

                if (processedCount === 0) { 
                    alert("No data found to save!"); 
                } else {
                    alert(`Successfully saved/updated ${processedCount} sets!`);
                    setWorkoutData(newWorkoutData);
                }
            };

            const renderProgressTab = () => {
                // Flatten all days
                let allExercises = [];
                Object.keys(workoutSplit).forEach(day => {
                    if (day !== 'Rest') allExercises = [...allExercises, ...workoutSplit[day]];
                });
                allExercises = [...new Set(allExercises)].sort(); 

                if (selectedHistoryExercise) {
                    return (
                        <div className="flex-1 p-4 md:p-8 overflow-hidden flex flex-col items-center">
                            <div className="w-full max-w-5xl h-full flex flex-col bg-slate-900/40 backdrop-blur-md rounded-3xl border border-slate-800/60 shadow-2xl overflow-hidden relative animate-fade-in">
                                <div className="flex bg-slate-900/80 border-b border-slate-800 sticky top-0 z-10 backdrop-blur-md p-4 items-center gap-2">
                                    <button onClick={() => setSelectedHistoryExercise(null)} className="p-2 bg-slate-800 rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 transition-all">â† Back</button>
                                    <h2 className="text-xl font-bold text-white line-clamp-1">{selectedHistoryExercise}</h2>
                                </div>
                                <div className="flex-1 overflow-y-auto space-y-6 p-4">
                                    <div className="p-4 bg-slate-900/50 rounded-xl border border-slate-800">
                                        <h3 className="text-sm font-bold text-slate-400 mb-4 flex items-center gap-2"><Icons.TrendingUp className="w-4 h-4 text-blue-500"/> Strength Progression</h3>
                                        {isLoadingHistory ? <div className="text-center py-8 text-slate-500 animate-pulse">Loading data...</div> : <ProgressChart historyData={historyData} />}
                                    </div>
                                    <div className="p-4 bg-slate-900/50 rounded-xl border border-slate-800">
                                        <h3 className="text-sm font-bold text-slate-400 mb-4 flex items-center gap-2"><Icons.List className="w-4 h-4 text-emerald-500"/> History Log</h3>
                                        <div className="space-y-2">
                                            <div className="grid grid-cols-4 text-xs font-bold text-slate-500 uppercase tracking-wider px-2 mb-2"><span>Date</span><span className="text-center">Set</span><span className="text-center">Kg</span><span className="text-center">Reps</span></div>
                                            {historyData.length > 0 ? historyData.map((row, idx) => (
                                                <div key={idx} className="grid grid-cols-4 text-sm text-slate-300 p-2 bg-slate-800/30 rounded-lg border border-slate-800/50 hover:border-slate-700 transition-colors">
                                                    <span className="text-slate-400">{row.Date}</span><span className="text-center text-slate-500">{idx + 1}</span><span className="text-center font-bold text-emerald-400">{row.Kg}</span><span className="text-center font-mono">{row.Reps}</span>
                                                </div>
                                            )) : <div className="text-center text-slate-500 py-4 text-sm">No recorded sets yet.</div>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                }
                return (
                     <div className="flex-1 p-4 md:p-8 overflow-hidden flex flex-col items-center">
                         <div className="w-full max-w-5xl h-full flex flex-col bg-slate-900/40 backdrop-blur-md rounded-3xl border border-slate-800/60 shadow-2xl overflow-hidden relative animate-fade-in">
                            <div className="text-center p-6 border-b border-slate-800/50 bg-slate-900/50"><h2 className="text-2xl font-bold text-white mb-1">Exercise History</h2><p className="text-slate-400 text-sm">Select an exercise to view your progress graph.</p></div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 overflow-y-auto p-4 custom-scrollbar">
                                {allExercises.map(ex => (
                                    <button key={ex} onClick={() => setSelectedHistoryExercise(ex)} className="p-4 bg-slate-800/50 hover:bg-slate-800 border border-slate-700 rounded-xl text-left transition-all hover:scale-[1.01] active:scale-[0.99] group"><span className="font-bold text-slate-200 group-hover:text-blue-400 transition-colors">{ex}</span></button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };
            
            // --- DATE HELPER FOR TABS ---
            const getTabDate = (dayName) => {
                // If using PPL, return nothing for now as logic is arbitrary
                if (programType === 'ppl') return null;

                // Simple map for Weekly program
                const dayMap = {
                    "Monday": 0, "Tuesday": 1, "Wednesday": 2, 
                    "Thursday": 3, "Friday": 4, "Saturday": 5, "Sunday": 6
                };
                
                // Better approach: Use index from workoutSplit keys
                const days = Object.keys(workoutSplit).filter(k => k !== 'Rest');
                const idx = days.indexOf(dayName);
                
                if (idx !== -1) {
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + idx);
                    return formatDate(date);
                }
                return null;
            };

            return (
                <div className="min-h-screen font-sans selection:bg-emerald-500/30 flex flex-col overflow-hidden bg-slate-950">
                    <nav className="sticky top-0 z-30 bg-slate-900/90 backdrop-blur-md border-b border-slate-800 px-4 h-12 flex items-center justify-between shadow-lg flex-none">
                        <div className="flex items-center gap-2"><div className="p-1.5 bg-emerald-500/10 rounded-lg"><Icons.Activity className="w-5 h-5 text-emerald-400" /></div><div><h1 className="font-bold text-sm text-white leading-tight">Weekly Split</h1></div></div>
                         
                         <div className="flex items-center gap-2">
                             <div className="flex items-center bg-slate-800/80 border border-slate-700 rounded-lg p-0.5">
                                 <button onClick={() => changeWeek(-1)} className="p-1.5 text-slate-400 hover:text-white transition-colors active:scale-90"><Icons.ChevronLeft className="w-3.5 h-3.5" /></button>
                                 <span className="px-2 text-[10px] font-mono font-bold text-emerald-400 select-none whitespace-nowrap min-w-[70px] text-center">{weekRangeString}</span>
                                 <button onClick={() => changeWeek(1)} className="p-1.5 text-slate-400 hover:text-white transition-colors active:scale-90"><Icons.ChevronRight className="w-3.5 h-3.5" /></button>
                             </div>
                             <button onClick={() => setShowEditModal(true)} className="p-1.5 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors"><Icons.Settings className="w-4 h-4" /></button>
                         </div>
                    </nav>

                    <div className="sticky top-12 z-20 bg-slate-950 border-b border-slate-800 overflow-x-auto no-scrollbar flex-none h-12 flex items-center">
                        <div className="flex px-2 min-w-max">
                            {Object.keys(workoutSplit).map((day) => { 
                                const isRest = day === "Rest"; 
                                const isActive = activeDay === day; 
                                const dateStr = getTabDate(day);
                                return (
                                    <button key={day} onClick={() => { setActiveDay(day); setSelectedHistoryExercise(null); }} className={`relative px-3 py-1.5 mx-1 rounded-md text-xs font-bold transition-all duration-200 whitespace-nowrap flex flex-col items-center justify-center ${isActive ? (isRest ? 'bg-blue-500/20 text-blue-400 ring-1 ring-blue-500/50' : 'bg-emerald-500/20 text-emerald-400 ring-1 ring-emerald-500/50') : 'text-slate-400 hover:bg-slate-900 hover:text-slate-200'}`}>
                                        <div className="flex items-center gap-1.5">
                                            {day}
                                            {dateStr && <span className={`text-[9px] font-mono opacity-80 ${isActive ? 'text-emerald-300' : 'text-slate-500'}`}>{dateStr}</span>}
                                        </div>
                                    </button>
                                ); 
                            })}
                             <button onClick={() => setActiveDay('Progress')} className={`relative px-3 py-1.5 mx-1 rounded-md text-xs font-bold transition-all duration-200 whitespace-nowrap ${activeDay === 'Progress' ? 'bg-purple-500/20 text-purple-400 ring-1 ring-purple-500/50' : 'text-slate-400 hover:bg-slate-900 hover:text-slate-200'}`}>Progress</button>
                        </div>
                    </div>

                    <main className="flex-1 overflow-hidden flex flex-col relative bg-slate-950">
                        {activeDay === "Rest" ? (
                            <div className="h-full flex flex-col items-center justify-center p-8 text-center opacity-0 animate-fade-in"><div className="p-4 bg-blue-500/10 rounded-full mb-4 ring-4 ring-blue-500/20"><Icons.Coffee className="w-12 h-12 text-blue-400" /></div><h2 className="text-2xl font-bold text-white mb-2">Rest Day</h2><p className="text-slate-400 max-w-sm text-sm leading-relaxed mb-6">Recover, eat well, sleep tight. Your muscles are growing right now.</p><button onClick={() => setShowResetConfirm(true)} className="px-5 py-2.5 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 rounded-lg flex items-center gap-2 transition-all font-bold text-xs active:scale-95"><Icons.Refresh className="w-4 h-4" />Reset Week</button></div>
                        ) : activeDay === "Progress" ? ( renderProgressTab() ) : (
                            /* TABLE VIEW START */
                            <div className="flex-1 p-4 md:p-8 overflow-hidden flex flex-col items-center">
                                <div className="w-full max-w-5xl h-full flex flex-col bg-slate-900/40 backdrop-blur-md rounded-3xl border border-slate-800/60 shadow-2xl overflow-hidden relative animate-fade-in">
                                    {/* TABLE HEADER */}
                                    <div className="flex bg-slate-900/80 border-b border-slate-800 sticky top-0 z-10 backdrop-blur-md">
                                        <div className="flex-none w-40 md:w-64 p-3 border-r border-slate-800 z-20 flex items-center justify-between">
                                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Exercise</span>
                                            <span className="text-[10px] font-bold text-slate-600 uppercase tracking-widest hidden md:inline">{currentExercises.length} Total</span>
                                        </div>
                                        <div className="flex flex-1 overflow-x-auto no-scrollbar">
                                            {sessions.map((session) => (
                                                <div key={session} className="flex-1 min-w-[100px] py-2 px-1 border-r border-slate-800/50 flex flex-col items-center justify-center text-center">
                                                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{session.replace('Session ', 'S')}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* TABLE BODY */}
                                    <div className="flex-1 overflow-y-auto custom-scrollbar pb-16">
                                        {currentExercises.map((exercise, idx) => (
                                            <div key={exercise} className={`flex border-b border-slate-800/40 hover:bg-slate-800/30 transition-colors group ${idx % 2 === 0 ? 'bg-transparent' : 'bg-slate-900/20'}`}>
                                                <div className="flex-none w-40 md:w-64 py-2 px-3 border-r border-slate-800 sticky left-0 z-10 flex flex-col justify-center bg-slate-950/95 md:bg-transparent md:backdrop-blur-none group-hover:bg-slate-900/95 md:group-hover:bg-transparent transition-colors">
                                                    <span className="text-xs md:text-sm font-semibold text-slate-300 leading-tight md:truncate whitespace-normal group-hover:text-emerald-200 transition-colors">{exercise}</span>
                                                    <span className="text-[9px] text-slate-600 md:hidden mt-0.5 font-mono truncate">{EXERCISE_NOTES[exercise] ? "Tip available" : ""}</span>
                                                </div>
                                                <div className="flex flex-1">
                                                    {sessions.map((session) => {
                                                        const completedSets = getCompletedSets(activeDay, exercise, session);
                                                        const isCompleted = completedSets.length > 0;
                                                        const isSelected = selectedCell?.exercise === exercise && selectedCell?.session === session;
                                                        
                                                        return (
                                                            <div key={`${exercise}-${session}`} className={`flex-1 min-w-[100px] p-1 border-r border-slate-800/30 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 relative ${isSelected ? 'bg-emerald-500/10 ring-1 ring-inset ring-emerald-500/50' : ''}`} onClick={() => { setSelectedCell({ dayKey: activeDay, exercise, session }); }} >
                                                                {isCompleted ? (
                                                                    <div className="flex flex-col gap-0.5 w-full px-1">
                                                                        {completedSets.map((set, idx) => (
                                                                            <div key={idx} className="flex justify-center items-center gap-0.5 text-[10px] font-mono text-emerald-400 bg-emerald-900/20 rounded px-1">
                                                                                <span className="font-bold">{set.weight}</span>
                                                                                <span className="text-slate-600 text-[8px]">Ã—</span>
                                                                                <span>{set.reps}</span>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                ) : (
                                                                    <div className="group/cell flex items-center justify-center w-full h-full py-3">
                                                                        <div className="h-6 w-12 rounded-full border border-slate-800 bg-slate-900/50 flex items-center justify-center text-[9px] text-slate-600 group-hover/cell:border-emerald-500/30 group-hover/cell:text-emerald-400 transition-all">
                                                                           Log
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {/* FOOTER ACTIONS */}
                                    <div className="absolute bottom-0 left-0 right-0 bg-slate-900/90 border-t border-slate-800 flex items-center justify-between p-3 z-30 backdrop-blur-md">
                                         <div className="flex gap-2 w-full justify-around">
                                            {sessions.map((session) => (
                                                <button key={session} onClick={() => handleSaveSession(session)} className="flex-1 max-w-[200px] py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-bold rounded shadow-lg shadow-emerald-900/20 transition-all flex items-center justify-center gap-2 active:scale-[0.98]">
                                                    <Icons.Save className="w-3 h-3" /> Save {session}
                                                </button>
                                            ))}
                                         </div>
                                    </div>
                                </div>
                            </div>
                            /* TABLE VIEW END */
                        )}
                    </main>

                    {/* MODALS */}
                    {selectedCell && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:justify-end pointer-events-none">
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity" onClick={() => setSelectedCell(null)}></div>
                            <div className="pointer-events-auto w-full sm:w-[380px] h-[75vh] sm:h-screen bg-slate-900 border-l border-slate-700 shadow-2xl transform transition-transform duration-300 flex flex-col animate-slide-up sm:animate-slide-left rounded-t-2xl sm:rounded-none">
                                <div className="p-4 border-b border-slate-800 flex justify-between items-start bg-slate-900 sticky top-0 rounded-t-2xl sm:rounded-none z-10">
                                    <div className="flex-1 mr-4">
                                        <h2 className="text-lg font-bold text-white mb-0.5 line-clamp-1">{selectedCell.exercise}</h2>
                                        <div className="flex items-center gap-2 text-emerald-400 text-xs font-medium uppercase tracking-wider"><Icons.Dumbbell className="w-3 h-3" /> {selectedCell.session}</div>
                                    </div>
                                    <button onClick={() => setSelectedCell(null)} className="p-2 -mr-2 text-slate-400 hover:text-white transition-colors"><Icons.X className="w-5 h-5" /></button>
                                </div>
                                <div className="flex-1 p-4 overflow-y-auto custom-scrollbar">
                                    <div className="space-y-4">
                                        <div className="flex items-center gap-3 px-2">
                                            <div className="w-6 text-center text-[10px] font-bold text-slate-500 uppercase">#</div>
                                            <div className="flex-1 grid grid-cols-2 gap-3">
                                                <div className="text-center text-[10px] font-bold text-slate-500 uppercase">KG</div>
                                                <div className="text-center text-[10px] font-bold text-slate-500 uppercase">REPS</div>
                                            </div>
                                        </div>
                                        
                                        {workoutData[selectedCell.dayKey]?.[selectedCell.exercise]?.[selectedCell.session]?.sets.map((set, index) => (
                                            <div key={index} className="flex items-center gap-3 mb-2">
                                                <div className="flex-none w-6 h-6 rounded bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-400 border border-slate-700">{index + 1}</div>
                                                <div className="flex-1 grid grid-cols-2 gap-3">
                                                    <input 
                                                        type="number" 
                                                        placeholder="-" 
                                                        value={set.weight} 
                                                        onChange={(e) => handleSetUpdate(selectedCell.dayKey, selectedCell.exercise, selectedCell.session, index, 'weight', e.target.value)} 
                                                        className="w-full bg-slate-950 border border-slate-700 rounded-md py-2 text-center font-mono text-sm text-white focus:outline-none focus:border-emerald-500 transition-colors placeholder:text-slate-800" 
                                                    />
                                                    <input 
                                                        type="number" 
                                                        placeholder="-" 
                                                        value={set.reps} 
                                                        onChange={(e) => handleSetUpdate(selectedCell.dayKey, selectedCell.exercise, selectedCell.session, index, 'reps', e.target.value)} 
                                                        className="w-full bg-slate-950 border border-slate-700 rounded-md py-2 text-center font-mono text-sm text-white focus:outline-none focus:border-emerald-500 transition-colors placeholder:text-slate-800" 
                                                    />
                                                </div>
                                            </div>
                                        ))}

                                        <div className="mt-6 space-y-3">
                                            {EXERCISE_NOTES[selectedCell.exercise] && (
                                                <div className="p-3 rounded-lg bg-blue-500/10 border border-blue-500/20">
                                                    <h4 className="flex items-center gap-1.5 text-xs font-bold text-blue-400 mb-1"><Icons.Lightbulb className="w-3 h-3" /> Form Tip</h4>
                                                    <p className="text-xs text-slate-300 leading-relaxed">{EXERCISE_NOTES[selectedCell.exercise]}</p>
                                                </div>
                                            )}
                                            
                                            <div>
                                                <h4 className="flex items-center gap-1.5 text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Notes</h4>
                                                <textarea 
                                                    value={workoutData[selectedCell.dayKey]?.[selectedCell.exercise]?.[selectedCell.session]?.comment || ''} 
                                                    onChange={(e) => handleCommentUpdate(selectedCell.dayKey, selectedCell.exercise, selectedCell.session, e.target.value)} 
                                                    className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-300 focus:outline-none focus:border-emerald-500 transition-colors resize-none h-20 placeholder:text-slate-600"
                                                    placeholder="Weights felt heavy? Shoulder pain?"
                                                ></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 border-t border-slate-800 bg-slate-900 pb-8 sm:pb-4">
                                    <button onClick={() => setSelectedCell(null)} className="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg shadow-emerald-900/20 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                                        <Icons.Check className="w-4 h-4" /> Save & Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showResetConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                            <div className="bg-slate-900 border border-slate-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl">
                                <h3 className="text-lg font-bold text-white mb-2">Reset Weekly Data?</h3>
                                <p className="text-slate-400 text-sm mb-6">This will clear all logged sets for the current week. This cannot be undone.</p>
                                <div className="flex gap-3"><button onClick={() => setShowResetConfirm(false)} className="flex-1 py-2.5 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-lg text-sm transition-colors">Cancel</button><button onClick={resetAllData} className="flex-1 py-2.5 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg text-sm transition-colors">Reset Data</button></div>
                            </div>
                        </div>
                    )}

                    {showEditModal && <EditExercisesModal currentSplit={workoutSplit} initialType={programType} onClose={() => setShowEditModal(false)} onSave={handleSaveSplit} />}
                    
                    {showFirebaseAlert && (
                        <div className="fixed top-0 left-0 right-0 p-2 bg-red-500/90 text-white text-center font-bold z-[60] backdrop-blur-sm">
                            <div className="flex items-center justify-center gap-2 text-xs">
                                <Icons.Alert className="w-4 h-4" />
                                <span>Cloud Sync Disabled (No Keys)</span>
                                <button onClick={() => setShowFirebaseAlert(false)} className="ml-2 hover:bg-white/20 rounded p-0.5"><Icons.X className="w-3 h-3" /></button>
                            </div>
                        </div>
                    )}
                    
                    {/* PORTRAIT ROTATION PROMPT */}
                    <div className="fixed inset-0 z-[9999] bg-slate-950 flex flex-col items-center justify-center p-6 text-center md:hidden portrait:flex landscape:hidden">
                       <Icons.RotateCcw className="w-12 h-12 text-emerald-500 mb-4 animate-spin" />
                       <h2 className="text-xl font-bold text-white mb-2">Rotate Your Phone</h2>
                       <p className="text-slate-400 text-sm">This app is optimized for landscape mode.</p>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
